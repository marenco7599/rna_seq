singularity {
    enabled = true
    // Monta l'intera cartella hpcnfs per l'accesso ai dati e software
    runOptions = '--bind /hpcnfs/'
}

env {
    // Usa LD_PRELOAD per caricare petalink.so
    LD_PRELOAD = "/hpcnfs/techunits/bioinformatics/software/petagene/petalink_1.3.15/bin/petalink.so"
    PETASUITE_REFPATH = "/hpcnfs/techunits/bioinformatics/software/petagene/petalink_1.3.15/species"
}

executor {
    name = 'pbspro'
    queue = 'workq'
    // Risorse richieste per il job PBS: 1 nodo, 12 CPU, 72 GB RAM e 16h
    submitOptions = '-l select=1:ncpus=12:mem=72gb,walltime=16:00:00'
}

process {
    // Default per tutti i processi
    cpus = 4
    memory = '16 GB'
    time = '4h'
    scratch = '/hpcnfs/scratch/UC/rna_seq/test/scratch/'

    // FASTQ_FASTQC_UMITOOLS_TRIMGALORE: trimming e QC, CPU medio, RAM alta
    withName: 'FASTQ_FASTQC_UMITOOLS_TRIMGALORE' {
        cpus = 8
        memory = '32 GB'
        time = '8h'
    }

    // STAR allineamento: CPU e RAM massima
    withName: 'STAR' {
        cpus = 12
        memory = '72 GB'
        time = '16h'
    }

    // FEATURECOUNTS: multi-thread medio, RAM medio
    withName: 'FEATURECOUNTS' {
        cpus = 8
        memory = '24 GB'
        time = '6h'
    }

    // TRIMGALORE standalone
    withName: 'TRIMGALORE' {
        cpus = 8
        memory = '32 GB'
        time = '8h'
    }

    // GTF_FILTER: leggero
    withName: 'GTF_FILTER' {
        cpus = 2
        memory = '6 GB'
        time = '1h'
    }
}

workflow {
    onComplete = {
        println "Pipeline completata con successo"
    }
    onError = { error ->
        println "Pipeline fallita: ${error.message}"
    }
}

